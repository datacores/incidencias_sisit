(function(m){var b;Consulta=function(a,e,d,c){this.contenedor=a||"body";b=_.isObject(this.contenedor)?this.contenedor:$(this.contenedor);this.ancho_tabla=71;this.ancho=150;this.ult_columna=0;this.activa=!1;this.consultas=[];this.url=d;this.campos=e||[];this.filtros={criterio:null,o1:null,o2:null,o3:null,o4:null,o5:null,o6:null,o7:null};this.ejecutar_callback=function(a){a=a||"Sin datos de consulta";console.log("Pulsado el boton ejecutar de la consulta:");console.debug(a)};_.isFunction(c)&&(this.ejecutar_callback=
c);this.nombre_consulta=null;this.html();this.comportamientos();this.leer_consultas()};Consulta.prototype.ejecutar_consulta=function(){var a=this.get_consulta_xFilas();console.log("Datos consulta en ejecutar_consulta:");console.debug(a);this.ejecutar_callback(a)};Consulta.prototype.html=function(){var a=this;$("<div>",{id:"filtro"}).append($("<div>",{id:"cabecera"}).append($("<h3>",{text:"\u00c1rea de consultas"}),$("<div>",{id:"herramientas"}).append($('<select id="selector_consulta" style="height:100%;">',
{}).append('<option value="-1">Seleccionar Consulta</option>'),$("<button>",{id:"ver_consulta",text:"Ver",title:"Ver en modo edici\u00f3n la consulta selecciona"}),$("<button>",{id:"ejecutar_consulta",text:"Ejecutar",title:"Ejecutar consulta seleccionada."}),$("<button>",{id:"nueva_consulta",text:"Nueva",title:"Nueva consulta vacia."}),$("<button>",{id:"guardar_consulta",text:"Guardar",title:"Grabar o actualizar consulta actual"}),$("<button>",{id:"renombrar_consulta",text:"Renombrar",title:"Renombrar consulta actual"}),
$("<button>",{id:"eliminar_consulta",text:"Borrar",title:"Borrar consulta actual"}),$("<button>",{id:"reset_consulta",text:"Reset",title:"Resetea listado y consultas."}))),$("<div>",{id:"cuerpo",css:{display:"none"}}).append($("<table>").append($("<tr>").append($("<td>",{"class":"etqu",text:"Campo:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"Ver:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"Orden:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"Criterio:"})),$("<tr>").append($("<td>",
{"class":"etqu",text:"o:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"o:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"o:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"o:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"o:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"o:"})),$("<tr>").append($("<td>",{"class":"etqu",text:"o:"}))))).hide().appendTo(this.contenedor).fadeIn();b.find("#cabecera").after('<div style="margin: 6px 5px;display:none;">\r\n\t\t\t\t\t\t\t<h4>Nuevo nombre para la consulta</h4>\r\n\t\t\t\t\t\t\t<input type="text" id="nombre_renombrar" style="width: 300px;height:26px;" placeholder="Introduzca nombre..." />\r\n\t\t\t\t\t\t\t<button id="cancelar_renombrar">Cancelar</button>\r\n\t\t\t\t\t\t\t<button id="btn_renombrar">Renombrar</button>\r\n\t\t\t\t\t\t</div>').after('<div style="margin: 6px 5px;display:none;">\r\n\t\t\t\t\t\t\t<h4>Nombre de la consulta a guardar</h4>\r\n\t\t\t\t\t\t\t<input type="text" id="nombre_guardar" style="width: 300px;height:26px;" placeholder="Introduzca nombre..." />\r\n\t\t\t\t\t\t\t<button id="cancelar_guardar">Cancelar</button>\r\n\t\t\t\t\t\t\t<button id="btn_guardar">Guardar</button>\r\n\t\t\t\t\t\t</div>');
_.each(this.campos,function(e){a.carga_columna(!1)})};Consulta.prototype.carga_columna=function(a){a=b.find("#filtro table tr");var e=this,d,c=this.ancho,g=this.campos,f=$('<select style="width:100%">');f.append('<option value="-1">Seleccione campo...</option>');_.each(g,function(a){f.append('<option value="'+a.id+'">'+a.nombre+"</option>")});e.ult_columna++;$.each(a,function(a){a++;1==a?(f.attr("columna",e.ult_columna),d=$('<td width="'+c+'px">').append(f)):d=2==a?$('<td width="'+c+'px">').append($("<input>",
{type:"checkbox",css:{width:"100%","text-align":"center","vertical-align":"middle"},columna:e.ult_columna,fila:a})):3==a?$('<td width="'+c+'px">').append($('<select style="width:100%;" columna="'+e.ult_columna+'" >').append("<option value=0></option><option value=1>Ascendente</option><option value=2>Descendente</option>")):$('<td width="'+c+'px">').append($("<input>",{css:{width:"100%"},"class":"condicion",columna:e.ult_columna,fila:a}));$(this).append(d)});this.ancho_tabla=parseInt(this.ancho_tabla)+
parseInt(c);b.find("table").css("width",this.ancho_tabla+"px");return!0};Consulta.prototype.comportamientos=function(){var a=this;b.on("keydown",function(a){var d=document.activeElement,c=parseInt(d.getAttribute("fila")),d=parseInt(d.getAttribute("columna"));switch(a.keyCode){case 37:d--;break;case 39:d++;break;case 38:c--;break;case 40:c++}b.find("input[fila="+c+"][columna="+d+"]").focus()});b.off("change","input.condicion");b.on("change","input.condicion",function(){a.cambia_condicion(this)});b.find("#ver_consulta").off("click");
b.find("#ver_consulta").on("click",function(a){-1!=$(this).html().search("Ocultar")?($(this).html("Ver"),b.find("#cuerpo").css("display","none")):($(this).html("Ocultar"),b.find("#cuerpo").css("display","block"))});b.find("#ejecutar_consulta").off("click");b.find("#ejecutar_consulta").on("click",function(){a.ejecutar_consulta()});b.find("#guardar_consulta").off("click");b.find("#guardar_consulta").on("click",function(e){var d=b.find("#btn_guardar").parent(),c=b.find("#cabecera");-1===parseInt(b.find("#selector_consulta").val())?
(c.css("display","none"),d.css("display","block"),d.find("#cancelar_guardar").off("click"),d.find("#cancelar_guardar").on("click",function(){$(this).find("input").val("");c.css("display","block");d.css("display","none")}),d.find("#btn_guardar").off("click"),d.find("#btn_guardar").on("click",function(){a.graba_consulta(b.find("#nombre_guardar").val(),!1,function(a){console.log("Consulta Grabada");console.debug(a);d.find("#cancelar_guardar").click()})})):a.graba_consulta(b.find("#selector_consulta").val(),
!1,function(a){console.log("Consulta grabada.");console.debug(a)})});b.find("#renombrar_consulta").off("click");b.find("#renombrar_consulta").on("click",function(e){var d=b.find("#btn_renombrar").parent(),c=b.find("#cabecera");c.css("display","none");d.css("display","block");d.find("#cancelar_renombrar").off("click");d.find("#cancelar_renombrar").on("click",function(){$(this).find("input").val("");c.css("display","block");d.css("display","none")});d.find("#btn_renombrar").off("click");d.find("#btn_renombrar").on("click",
function(){a.graba_consulta(b.find("#nombre_renombrar").val(),!0,function(a){console.log("Consulta renombrada");console.debug(a);d.find("#cancelar_renombrar").click()})})});b.find("#eliminar_consulta").off("click");b.find("#eliminar_consulta").on("click",function(b){b.preventDefault();b=$(b.currentTarget).parent().find("select");a.borra_consulta($(b).val())});b.find("#reset_consulta").off("click");b.find("#reset_consulta").on("click",function(b){b.preventDefault();a.reset_grid()})};Consulta.prototype.cambia_condicion=
function(a){a=$(a);var b=a.attr("fila");a.attr("columna");if(4>b)return!1;this.validar_condicion(a)?a.css("background-color","#dfd"):a.css("background-color","#fdd");1>a.val().length&&a.css("background-color","#fff")};Consulta.prototype.validar_condicion=function(a){a=a.val();var b=a.trim().substr(0,1);return-1=="*#<>!=%$".search(b)?!1:a};Consulta.prototype.get_consulta_xFilas=function(){var a=this,e=[];b.find("table > tbody > tr:nth-child(1) select");for(var d=b.find("table > tbody > tr:nth-child(2) input"),
c=b.find("table > tbody > tr:nth-child(3) select"),g=[],f=[],h=!1,l=4;12>l;l++){var k=b.find("*[fila="+l+"]"),k=_.filter(k,function(a){return 0<a.value.length}),k=_.map(k,function(d){var e=$(d).attr("columna"),c=b.find("select[columna="+e+"]"),c=$(c).val();d=a.validar_condicion($(d));return-1!=parseInt(c)&&d?{columna:e,campo:c,expresion:d}:(h=!0,!1)});if(h)break;else 0<k.length&&e.push(k)}c=_.filter(c,function(a){return 0<$(a).val()});_.each(c,function(a){var d=b.find("select[columna="+$(a).attr("columna")+
"]");a=$(a).val();f.push([d.val(),a])});d=_.filter(d,function(a){return $(a).is(":checked")});_.each(d,function(a){a=b.find("select[columna="+$(a).attr("columna")+"]");a=$(a).val();if(-1==parseInt(a))return h=!0,!1;g.push(a)});1>g.length&&(h=!0);return h?(alert("La consulta contiene errores:\n\n\r\n\t\t\t\tPor favor compruebe lo siguiente: \n\r\n\t\t\t\t\tQue no tenga ningun campo en rojo.\n\r\n\t\t\t\t\tQue ha seleccionado un campo en todas las columnas con condiciones.\n\r\n\t\t\t\t\tQue no tiene marcada para ver ninguna columna sin campo seleccionado.\n\r\n\t\t\t\t\tQue tiene marcado al menos un campo para consultar."),
!1):{campos:g,filtros:e,orden:f}};Consulta.prototype.get_consulta_xColumnas=function(){var a=this,e=b.find("table > tbody > tr:nth-child(1) select");b.find("table > tbody > tr:nth-child(2) input");b.find("table > tbody > tr:nth-child(3) select");var d=[],c={},e=_.filter(e,function(a){return-1!==parseInt($(a).val())});_.each(e,function(b){b=$(b).attr("columna");c={campo:a.get_campo(b),chekbox:a.get_ver(b),orden:a.get_orden(b),criterio:a.get_celda(4,b).val(),o1:a.get_celda(5,b).val(),o2:a.get_celda(6,
b).val(),o3:a.get_celda(7,b).val(),o4:a.get_celda(8,b).val(),o5:a.get_celda(9,b).val(),o6:a.get_celda(10,b).val(),o7:a.get_celda(11,b).val()};d.push(c)});return d};Consulta.prototype.reset_grid=function(){b.find("tr:nth-child(1) select").val("-1");b.find("tr:nth-child(2) input").prop("checked",!1);b.find("tr:nth-child(3) select").val("0");b.find("tr:nth-child(4) input").val("");b.find("tr:nth-child(5) input").val("");b.find("tr:nth-child(6) input").val("");b.find("tr:nth-child(7) input").val("");
b.find("tr:nth-child(8) input").val("");b.find("tr:nth-child(9) input").val("");b.find("tr:nth-child(10) input").val("");b.find("tr:nth-child(11) input").val("");this.activa=!1};Consulta.prototype.set_select_consultas=function(){var a=this,e=b.find("#selector_consulta");e.html('<option value="-1">Seleccionar Consulta</option>');_.each(a.consultas,function(a){e.append('<option value="'+a.nombre+'">'+a.nombre+"</option>")});e.off("change");e.on("change",function(b){b.preventDefault();var e=b.currentTarget;
b=parseInt($(e).val());a.reset_grid();(isNaN(b)||-1<b)&&_.each(a.consultas,function(b){if(b.nombre==$(e).val())return a.carga_consulta(b),!1})})};Consulta.prototype.carga_consulta=function(a){a=JSON.parse(a.template);var b=this;_.each(a,function(a,c){c++;b.set_campo(c,a.campo);b.set_ver(c,a.chekbox);b.set_orden(c,a.orden);b.set_celda(4,c,a.criterio);b.set_celda(5,c,a.o1);b.set_celda(6,c,a.o2);b.set_celda(7,c,a.o3);b.set_celda(8,c,a.o4);b.set_celda(9,c,a.o5);b.set_celda(10,c,a.o6);b.set_celda(11,c,
a.o7)})};Consulta.prototype.set_celda=function(a,e,d){b.find("*[fila="+a+"][columna="+e+"]").val(d)};Consulta.prototype.get_celda=function(a,e){return b.find("*[fila="+a+"][columna="+e+"]")};Consulta.prototype.set_campo=function(a,e){b.find("tr:nth-child(1) select[columna="+a+"]").val(e)};Consulta.prototype.get_campo=function(a){return b.find("tr:nth-child(1) select[columna="+a+"]").val()};Consulta.prototype.get_ver=function(a){return b.find("tr:nth-child(2) input[columna="+a+"]").is(":checked")};
Consulta.prototype.set_ver=function(a,e){b.find("tr:nth-child(2) input[columna="+a+"]").prop("checked",JSON.parse(e))};Consulta.prototype.get_orden=function(a){return b.find("tr:nth-child(3) select[columna="+a+"]").val()};Consulta.prototype.set_orden=function(a,e){b.find("tr:nth-child(3) select[columna="+a+"]").val(e)};Consulta.prototype.leer_consultas=function(a){var b=this;a?(this.consultas=a,this.set_select_consultas()):m.peticion("GET",b.url+"s",!1,"json",function(a){b.consultas=a;b.set_select_consultas()})};
Consulta.prototype.graba_consulta=function(a,e,d){var c=this,g=b.find("#selector_consulta"),f=b.find("#selector_consulta option:selected").text();a={nombre:a,template:this.get_consulta_xColumnas()};var h=-1!==parseInt(g.val())||e?"PUT":"POST";console.log("selector:");console.debug(g.val());e&&(a.antiguo_nombre=f);m.peticion(h,c.url,a,"json",function(a){_.isArray(a.template)&&(a.template=JSON.stringify(a.template));"POST"===h?c.consultas.push(a):$.each(c.consultas,function(b){if(this.nombre==f)return c.consultas[b]=
a,!1});c.set_select_consultas();d(a)})};return Consulta})(DAF.API);
