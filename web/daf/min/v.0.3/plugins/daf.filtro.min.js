(function(d){Condicion=function(b,a,c,d){this.cp=b;this.op=a;this.ex=c;this.id=d||null};Filtro=function(b){if(!DAF.API.tipo)throw"El plugin daf.filtros.js, necesita el plugin daf.validar.js para trabajar.";if(!DAF.API.no_acentos)throw"El plugin daf.filtros.js, necesita el plugin daf.utiles.js para trabajar.";try{_.isArray([])}catch(a){throw"Este plugin necesita la libreria underscore.js para trabajar.";}this.union=b||!1;this.condiciones=[];this.omisiones=[]};Filtro.prototype.reset_condiciones=function(){this.condiciones=
[]};Filtro.prototype.set_omisiones=function(b){_.isString(b)&&this.omisiones.push(b);_.isArray(b)&&(this.omisiones=_.union(this.omisiones,b))};Filtro.prototype.add_condicion=function(){var b=Array.prototype.slice.call(arguments,0),a=b[0],c=b[1].trim(),d=b[2]||this.condiciones.length+1,f=this,e=c.charCodeAt(0),g=c.substr(1).trim(),b=DAF.API.tipo.call(a),h=function(a){var b;(b=_.findWhere(f.condiciones,{id:a.id}))?1>a.ex.length?f.del_condicion(a.id):(b.op=a.op,b.ex=a.ex.trim()):f.condiciones.push(a)};
if(-1=="*#<>!=%$".search(String.fromCharCode(e)))return"Expresion sin operador u operador no valido, al a\u00f1adir condicion al filtro.";if("string"===b.toLowerCase()){var k=new Condicion(a,e,g,d);h(k)}else"array"===b.toLowerCase()&&_.each(a,function(b){k=new Condicion(a,e,g,d);h(k)})};Filtro.prototype.del_condicion=function(b){this.condiciones=_.filter(this.condiciones,function(a){return a.id!=b})};Filtro.prototype.aplicar_filtro=function(b){if(0===this.condiciones.length)return b;var a=this,c=
this.union?[]:b;_.each(a.condiciones,function(d){c=a.union?_.uniq(c.concat(a.aplicar_condicion(d,b))):a.aplicar_condicion(d,c)});return c};Filtro.prototype.aplicar_condicion=function(b,a){var c=b.cp,d=isNaN(parseInt(b.op))?b.op.charCodeAt(0):parseInt(b.op),f=b.ex,e=[],g=this;if(""==f)return a;"*"==c?_.each(a,function(a){$.each(a,function(){if(g.compara_expresion(this,f,d))return e.push(a),!1})}):_.each(a,function(a){g.compara_expresion(a[c],f,d)&&e.push(a)});return e};Filtro.prototype.compara_expresion=
function(){var b=Array.prototype.slice.call(arguments,0);if(3!=b.length)return!1;var a=b[0],c=b[1];if(!a&&isNaN(a)||!c&&isNaN(a))return!1;switch(b[2]){case 35:return a===c;case 60:case 62:return b=60===b[2]?!0:!1,isNaN(a)||isNaN(c)?d.validar("fecha",a)&&d.validar("fecha",c)?b?d.fecha_2obj(c)>d.fecha_2obj(a):d.fecha_2obj(c)<d.fecha_2obj(a):!1:b?parseFloat(c)>parseFloat(a):parseFloat(c)<parseFloat(a);case 61:if(parseFloat(a)===parseFloat(c))return!0;c+="";return(a+"").toLowerCase()===c.toLowerCase()?
!0:!1;case 33:return c!=a;case 37:return a+="",c+="",0==a.length||0==c.length||-1<a.search("Object]")||-1<c.search("Object]")?!1:-1<d.no_acentos(a.toLowerCase()).search(d.no_acentos(c.toLowerCase()));case 36:return-1==a.toLowerCase().search(c.toLowerCase());default:return!1}};d.aplicar_filtro=function(b,a){if(_.isArray(a)){if(!b.condiciones)throw"El metodo aplicar_filtro, necesita un filtro como primer parametro.";if(!typeof a||!_.isArray(a)||0< !a.length||!_.isObject(a[0]))throw"Los datos a filtrar no son un Array de datos, el array est\u00e1 vacio, mal formado, o no es un array de objetos";
return b.aplicar_filtro(a||this)}_.isString(a)&&$.ajax({url:a,type:"GET",data:{filtro:JSON.stringify(b)}}).done(function(a){console.log("Respuesta:");console.debug(a);return a}).fail(function(a){console.log(a)})};d.aplicar_filtros=function(b,a,c){c=c||!1;if(_.isArray(a)){var d=[];if(!_.isArray(b)||1>b.length)return a;if(c)for(;0<b.length;)d=_.union(d,b.shift().aplicar_filtro(a));else for(d=a;0<b.length;)d=b.shift().aplicar_filtro(d);return d}_.isString(a)};d.aplicar_condicion=function(b,a){return Filtro.prototype.aplicar_condicion(b,
a||this)};d.aplicar_busqueda=function(b,a,c,d){c=c||"and";var f=d||"*";b=b.split(" ");var e=!1,g=!1,h=!1;c=c.toLowerCase();if(""!==c&&"and"!==c&&"or"!==c&&"all"!==c)throw"El tercer parametro ( union ), debe ser and, or, all, '', u omitirse.";if(!_.isArray(a)||!_.isObject(a[0]))throw"Datos a filtrar debe de ser un array de objetos";if(0==a.length)throw"No hay datos para filtrar";b=_.map(b,function(a){return"%"+a});""===c||"all"===c?(g=new Filtro(!1),h=new Filtro(!0)):"and"===c?e=new Filtro(!1):"or"===
c&&(e=new Filtro(!0));if(e)return _.each(b,function(a){e.add_condicion(f,a)}),e.aplicar_filtro(a);if(g&&h)return _.each(b,function(a){g.add_condicion(f,a)}),_.each(b,function(a){h.add_condicion(f,a)}),_.uniq(g.aplicar_filtro(a).concat(h.aplicar_filtro(a)))};d.eventos.push(["inicio",function(){this.interno.extender({aplicar_filtro:d.aplicar_filtro},Array.prototype);this.interno.extender({aplicar_filtros:d.aplicar_filtros},Array.prototype);this.interno.extender({aplicar_condicion:d.aplicar_condicion},
Array.prototype);this.interno.extender({aplicar_busqueda:d.aplicar_busqueda},Array.prototype);$&&($.fn.aplicar_filtro=d.aplicar_filtro);$&&($.fn.aplicar_filtros=d.aplicar_filtros);$&&($.fn.aplicar_condicion=d.aplicar_condicion);$&&($.fn.aplicar_busqueda=d.aplicar_busqueda)}])})(DAF.API);
